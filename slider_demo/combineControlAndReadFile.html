<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>jQuery UI Slider - Default functionality</title>
 <script  type="text/javascript" src="../d3-3.1.0/d3.min.js"></script>
  <link rel="stylesheet" href="jquery-ui.css">
  <script src="jquery-1.10.2.js"></script>
  <script src="jquery-ui.js"></script>
  <script>
  var Lock = 1;//deliver locl

  $(function() {
    $("#slider").slider({
      min: 1994,
      max: 2010,
      value:1994,
      create: function(event, ui){
        document.getElementById("show_something").innerHTML = $("#slider").slider("option", "value");
        //console.log(dataset);
          readfile();
      },
      change: function( event, ui ) {
      }
    })
    $( "#slider" ).slider({
      slide: function(event, ui){
        document.getElementById("show_something").innerHTML = ui.value;
      }
    });

  });

  var datasetMale = [];
  var datasetFemale = [];
  var maxMale = [];
  var maxFemale = [];
  var codeArray = [];
  var dictionary = [];//for all code dictionary
  var fullNameCode = [];
  function readfile(){
    var FilePath = "../raw_data_c/";
    var Male = "MC.csv";
    var Female = "FC.csv";

    //var year = 1994;


  for(var year=1994;year<2011;year++)
  {
    var outPutPath = FilePath + year + Male;
    d3.csv(outPutPath,function(error,csvdata){
   var ArrayForOneTable = [];
   var CodeForOneTable = [];
   if(error){
     console.log(error);
   }
   var MaxValue = 0;
   for( var i=0; i<csvdata.length; i++ ){

     var contentName = csvdata[i]["ICD10"];
     var ObjectForOneRows = new Object();
     dictionary.push(contentName);
     ObjectForOneRows.code = contentName.substr(0,contentName.indexOf(" "));
     CodeForOneTable.push(ObjectForOneRows.code);
     var content = [];
     for(var j=0; j<16;++j)
     {
       var ObjectForLocationXandY = new Object();
       var temp1 = j*5;
       var temp2 = 4+j*5;
       var tempTotal = temp1 + "_" +temp2;
       //console.log(tempTotal);
       ObjectForLocationXandY.y   = parseInt(csvdata[i][tempTotal]);

       if(ObjectForLocationXandY.y>MaxValue)
       MaxValue = ObjectForLocationXandY.y;

       ObjectForLocationXandY.x   = temp1;
       content.push(ObjectForLocationXandY);
     }
     ObjectForLocationXandY.y   = parseInt(csvdata[i]["85"]);
     ObjectForLocationXandY.x   = 85;
     content.push(ObjectForLocationXandY);
     //console.log(content);
     ObjectForOneRows.rate = content;
     ArrayForOneTable.push(ObjectForOneRows);

     content = [];
      }
      datasetMale.push(ArrayForOneTable);


      //if(datasetMale.length==17)
      //console.log(datasetMale);

      //console.log(MaxValue);
      //console.log(CodeForOneTable.length);
      codeArray.push(CodeForOneTable);
      maxMale.push(MaxValue);
    });
  }

  for(var year=1994;year<2011;year++)
  {

    var outPutPath = FilePath + year + Female;
    d3.csv(outPutPath,function(error,csvdata){
   var ArrayForOneTable = [];
   var CodeForOneTable = [];
   var MaxValue = 0;
   if(error){
     console.log(error);
   }

   for( var i=0; i<csvdata.length; i++ ){
     var contentName = csvdata[i]["ICD10"];
     var ObjectForOneRows = new Object();
     dictionary.push(contentName);
     ObjectForOneRows.code = contentName.substr(0,contentName.indexOf(" "));
     CodeForOneTable.push(ObjectForOneRows.code);
     var content = [];
     for(var j=0; j<16;++j)
     {
       var ObjectForLocationXandY = new Object();
       var temp1 = j*5;
       var temp2 = 4+j*5;
       var tempTotal = temp1 + "_" +temp2;
       //console.log(tempTotal);
       ObjectForLocationXandY.y   = parseInt(csvdata[i][tempTotal]);
       ObjectForLocationXandY.x   = temp1;
       if(ObjectForLocationXandY.y>MaxValue)
       MaxValue = ObjectForLocationXandY.y;
       content.push(ObjectForLocationXandY);
     }
     ObjectForLocationXandY.y   = parseInt(csvdata[i]["85"]);
     ObjectForLocationXandY.x   = 85;
     content.push(ObjectForLocationXandY);
     //console.log(content);
     ObjectForOneRows.rate = content;
     ArrayForOneTable.push(ObjectForOneRows);

     content = [];
      }
      datasetFemale.push(ArrayForOneTable);


      //if(datasetFemale.length==17)
      //console.log(datasetFemale);
      codeArray.push(CodeForOneTable);
      //console.log(MaxValue);
      maxFemale.push(MaxValue);
    });

  }


  setInterval(
    function(){
      if(datasetMale.length>0&&datasetFemale.length>0){

        //  -----------y index max calculation-------------
        if(maxFemale.length>0&&maxMale.length>0&&Lock==1){
        yIndexMax = Math.max.apply(null,maxFemale.concat(maxMale));
        console.log(yIndexMax);
        Lock++;
        };

        var resultArray = codeArray[0];// the unique code in table
        if(codeArray.length>0)
        {
          if(Lock==2)
          {
            for(var i=1;i<(codeArray.length);++i)
            {
              var tempArray = [];
              for(var j=0;j<resultArray.length;++j)
              {
                for(var k=0;k<codeArray[i].length;++k)
                {
                  if(resultArray[j]==codeArray[i][k])
                  {
                    tempArray.push(codeArray[i][k]);
                  }
                }
              }
              resultArray = tempArray;
            }
            console.log(resultArray);
            Lock++;
          }

          ///----------datasetMale processing------------
          if(Lock==3)
          {
            for(var i=0;i<datasetMale.length;i++)
            {
              for(var j=0;j<datasetMale[i].length;j++)
              {
                  var flag = 1;
                  for(var k=0;k<resultArray.length;k++)
                  {
                    if(datasetMale[i][j].code==resultArray[k]){
                      flag = 0;
                    }
                  }
                  if(flag)
                  {
                    datasetMale[i].splice(j,1);
                    j = -1;
                  }
              }

            }
            Lock++;
          }

          if(Lock==4)
          {
            for(var i=0;i<datasetFemale.length;i++)
            {
              for(var j=0;j<datasetFemale[i].length;j++)
              {
                  var flag = 1;
                  for(var k=0;k<resultArray.length;k++)
                  {
                    if(datasetFemale[i][j].code==resultArray[k]){
                      flag = 0;
                    }
                  }
                  if(flag)
                  {
                    datasetFemale[i].splice(j,1);
                    j = -1;
                  }
              }

            }
            Lock++;//end the lock
          }

          if(Lock==5){
            //combine the whole dictionary
            for(var i = 0;i<dictionary.length;++i){
              for(var j = i+1;j<dictionary.length;++j){
                if(dictionary[i]==dictionary[j]){
                  dictionary.splice(j,1);
                }
              }
            }

            for(var i=0;i<dictionary.length;++i)
            {
              for(var j=0;j<resultArray.length;++j)
              {
                if(dictionary[i].substr(0,dictionary[i].indexOf(" "))==resultArray[j])
                {
                  fullNameCode.push(dictionary[i]);
                }

              }
            }


            Lock = 0;
          }


        }

      }

    }
    ,1000);


}

  </script>
</head>
<body>
<div id="slider"></div>
<p id="show_something"></p>

</body>
</html>
